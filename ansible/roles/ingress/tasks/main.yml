---

- name: import ssl certificate
  shell: |
    kubectl create secret tls {{ ingress_cert_name }} --key {{ ingress_cert_key }} --cert {{ ingress_cert_path }}
    touch ~/.ingress_cert_secret
  args:
    executable: /bin/bash
    creates: ~/.ingress_cert_secret

- name: Add nginx ingress chart repo
  kubernetes.core.helm_repository:
    name: ingress-nginx
    repo_url: "https://kubernetes.github.io/ingress-nginx"

- name: Deploy Nginx Ingress
  kubernetes.core.helm:
    name: ingress-nginx
    chart_ref: ingress-nginx/ingress-nginx
    chart_version: 4.3.0
    release_namespace: k8s
    create_namespace: yes

- name: Wait for ingress become created
  shell: "kubectl get po --namespace=k8s --selector app.kubernetes.io/name=ingress-nginx --output=jsonpath='{.items[*].metadata.name}'"
  register: ingress_pods_created
  until: item in ingress_pods_created.stdout
  retries: 30
  delay: 10
  with_items:
    - ingress-nginx-controller

- name: Wait for ingress pods become ready
  shell: "kubectl wait --namespace=k8s --for=condition=Ready pods --selector app.kubernetes.io/name=ingress-nginx --timeout=600s"

#- name: Ensure ingress is ready
#  pause:
#    seconds: 150

- name: Delete ingress admission webhook
  shell: kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
