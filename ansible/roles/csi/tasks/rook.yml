---

- name: Create rook namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        labels:
          kubernetes.io/metadata.name: "{{ csi_rook_namespace }}"
          name: "{{ csi_rook_namespace }}"
          pod-security.kubernetes.io/enforce: baseline
        name: "{{ csi_rook_namespace }}"

- name: Add rook ingress chart repo
  kubernetes.core.helm_repository:
    name: rook
    repo_url: "https://charts.rook.io/release"

- name: Deploy Rook
  kubernetes.core.helm:
    name: rook
    chart_ref: rook/rook-ceph
    #chart_version: "{{ csi_rook_chart_version }}"
    release_namespace: "{{ csi_rook_namespace }}"
    create_namespace: true

- name: Rook CSI Cluster Init
  kubernetes.core.k8s:
    state: present
    template: templates/rook-cluster.yml.j2

- name: Wait for CSI pods become created
  ansible.builtin.shell: "kubectl get po --namespace=kube-rook --output=jsonpath='{.items[*].metadata.name}'"
  register: csi_pods_created
  until: item in csi_pods_created.stdout
  retries: 30
  delay: 10
  with_items:
    - calico-node
  changed_when: false

- name: Wait for csi pods become ready
  ansible.builtin.command: "kubectl wait --namespace=kube-rook --for=condition=Ready pods --selector k8s-app=rook-node --timeout=600s"
  changed_when: false

...
